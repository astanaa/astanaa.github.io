<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World's Education</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            background: url('https://raw.githubusercontent.com/astanaa/Data_Visualization_Project/main/Images/sky%20full%20of%20stars.jpg') center/cover fixed;
            overflow: hidden;
            height: 100vh;
        }

        #landing-page {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: transform 0.8s ease-in-out;
            z-index: 100;
            opacity: 0;
            animation: fadeIn 1.5s ease-in forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        #landing-page.slide-up {
            transform: translateY(-100vh);
        }

        .landing-content {
            max-width: 800px;
            padding: 40px;
            text-align: center;
        }

        .landing-paragraph {
            font-size: clamp(14px, 2.5vw, 20px);
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .unesco-link {
            display: block;
            text-align: center;
            margin-bottom: 35px;
            font-size: clamp(13px, 2vw, 16px);
        }

        .unesco-link a {
            color: rgba(95, 179, 246, 0.9);
            text-decoration: underline;
            text-underline-offset: 3px;
            transition: all 0.3s;
        }

        .unesco-link a:hover {
            color: #5fb3f6;
            text-shadow: 0 0 10px rgba(95, 179, 246, 0.5);
        }

        .uncover-btn {
            background: rgba(95, 179, 246, 0.2);
            border: 2px solid rgba(95, 179, 246, 0.6);
            color: #5fb3f6;
            padding: 18px 45px;
            font-size: clamp(16px, 2vw, 20px);
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 30px rgba(95, 179, 246, 0.3);
        }

        .uncover-btn:hover {
            background: rgba(95, 179, 246, 0.4);
            border-color: rgba(95, 179, 246, 0.9);
            box-shadow: 0 0 50px rgba(95, 179, 246, 0.6);
            transform: translateY(-3px);
        }

        .uncover-btn:active {
            transform: translateY(-1px);
        }

        #visualization-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 100vh;
            left: 0;
            transition: transform 0.8s ease-in-out;
        }

        #visualization-container.slide-up {
            transform: translateY(-100vh);
        }

        .fade-top-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
            z-index: 10;
            pointer-events: none;
        }

        .title {
            position: absolute;
            top: 40px;
            left: 40px;
            z-index: 20;
            font-size: clamp(1.2em, 4vw, 2em);
            font-weight: 600;
            color: #5fb3f6;
            text-shadow: 0 0 20px rgba(95, 179, 246, 0.4);
        }

        .nav-container {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            gap: 15px;
            background: rgba(10, 20, 40, 0.8);
            padding: 8px;
            border-radius: 30px;
            border: 1px solid rgba(95, 179, 246, 0.3);
            backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: clamp(12px, 2vw, 14px);
            font-weight: 600;
            transition: all 0.3s;
            user-select: none;
            white-space: nowrap;
        }

        .nav-btn:hover { color: #5fb3f6; background: rgba(95, 179, 246, 0.1); }
        .nav-btn.active { color: #fff; background: rgba(95, 179, 246, 0.3); box-shadow: 0 0 15px rgba(95, 179, 246, 0.3); }

        .search-container {
            position: absolute;
            top: 45px;
            right: 57px;
            z-index: 20;
            width: min(280px, 35vw);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(10, 20, 40, 0.9);
            border: 1px solid rgba(95, 179, 246, 0.3);
            border-radius: 25px;
            color: white;
            font-size: clamp(12px, 2vw, 14px);
            outline: none;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .search-input:focus {
            border-color: rgba(95, 179, 246, 0.6);
            box-shadow: 0 0 15px rgba(95, 179, 246, 0.2);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(10, 20, 40, 0.95);
            border: 1px solid rgba(95, 179, 246, 0.3);
            border-radius: 10px;
            margin-top: 8px;
            max-height: 250px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .search-results.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            font-size: clamp(12px, 1.8vw, 13px);
            border-bottom: 1px solid rgba(95, 179, 246, 0.1);
            transition: all 0.2s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: rgba(95, 179, 246, 0.1);
            color: #5fb3f6;
        }

        .search-results::-webkit-scrollbar {
            width: 6px;
        }

        .search-results::-webkit-scrollbar-track {
            background: rgba(95, 179, 246, 0.05);
        }

        .search-results::-webkit-scrollbar-thumb {
            background: rgba(95, 179, 246, 0.3);
            border-radius: 3px;
        }

        .search-results::-webkit-scrollbar-thumb:hover {
            background: rgba(95, 179, 246, 0.5);
        }

        .globe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.8s ease-in-out;
        }

        .globe-container.slide-up {
            transform: translateY(-100vh);
        }

        .chart-container {
            position: absolute;
            top: 100vh;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.8s ease-in-out;
        }

        .chart-container.slide-up {
            transform: translateY(-100vh);
        }

        .controls {
            position: absolute;
            bottom: 40px;
            right: 40px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-btn {
            background: rgba(10, 20, 40, 0.9);
            border: 1px solid rgba(95, 179, 246, 0.3);
            color: #5fb3f6;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(12px, 2vw, 14px);
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            user-select: none;
            white-space: nowrap;
        }

        .control-btn:hover {
            background: rgba(95, 179, 246, 0.2);
            border-color: rgba(95, 179, 246, 0.6);
            box-shadow: 0 0 15px rgba(95, 179, 246, 0.3);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .chart-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            gap: 12px;
            background: rgba(10, 20, 40, 0.9);
            padding: 8px;
            border-radius: 30px;
            border: 1px solid rgba(95, 179, 246, 0.3);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            justify-content: center;
        }

        .chart-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: clamp(11px, 1.8vw, 13px);
            font-weight: 600;
            transition: all 0.3s;
            user-select: none;
            white-space: nowrap;
        }

        .chart-btn:hover {
            color: #5fb3f6;
            background: rgba(95, 179, 246, 0.1);
        }

        .chart-btn.active {
            color: #fff;
            background: rgba(95, 179, 246, 0.3);
            box-shadow: 0 0 15px rgba(95, 179, 246, 0.3);
        }

        .scatter-description {
            position: absolute;
            top: 120px;
            left: 40px;
            max-width: min(350px, 30vw);
            background: rgba(10, 20, 40, 0.9);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(95, 179, 246, 0.3);
            color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            z-index: 15;
        }

        #tooltip {
            position: absolute;
            background: rgba(10, 20, 40, 0.95);
            border: 1px solid rgba(95, 179, 246, 0.4);
            border-radius: 8px;
            padding: 12px 16px;
            pointer-events: none;
            font-size: clamp(11px, 1.8vw, 13px);
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #tooltip.show {
            opacity: 1;
        }

        .tooltip-country {
            font-weight: 600;
            color: #5fb3f6;
            margin-bottom: 6px;
        }

        .tooltip-score {
            color: rgba(255, 255, 255, 0.9);
            font-size: clamp(10px, 1.6vw, 12px);
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .title {
                top: 15px;
                left: 15px;
                font-size: 1.2em;
            }

            .nav-container {
                top: 15px;
                gap: 8px;
                padding: 6px;
            }

            .nav-btn {
                padding: 8px 15px;
                font-size: 11px;
            }

            .search-container {
                top: 70px;
                right: 15px;
                left: 15px;
                width: auto;
            }

            .controls {
                bottom: 20px;
                right: 20px;
                gap: 10px;
            }

            .control-btn {
                padding: 10px 18px;
                font-size: 12px;
            }

            .chart-controls {
                bottom: 20px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                gap: 8px;
                padding: 6px;
                max-width: 90vw;
            }

            .chart-btn {
                padding: 8px 15px;
                font-size: 11px;
            }

            .scatter-description {
                top: 110px;
                left: 15px;
                right: 15px;
                max-width: calc(100vw - 30px);
                padding: 15px;
            }

            .fade-top-overlay {
                height: 120px;
            }

            .landing-content {
                padding: 20px;
            }

            .landing-paragraph {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .unesco-link {
                font-size: 12px;
                margin-bottom: 25px;
            }

            .uncover-btn {
                padding: 14px 35px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .title {
                font-size: 1em;
                top: 12px;
                left: 12px;
            }

            .nav-container {
                top: 12px;
                gap: 6px;
                padding: 5px;
            }

            .nav-btn {
                padding: 6px 12px;
                font-size: 10px;
            }

            .search-container {
                top: 60px;
                right: 12px;
                left: 12px;
            }

            .search-input {
                padding: 10px 14px;
                font-size: 12px;
            }

            .controls {
                bottom: 15px;
                right: 15px;
                gap: 8px;
            }

            .control-btn {
                padding: 8px 16px;
                font-size: 11px;
            }

            .chart-controls {
                bottom: 15px;
                gap: 6px;
                padding: 5px;
            }

            .chart-btn {
                padding: 6px 12px;
                font-size: 10px;
            }

            .scatter-description {
                top: 95px;
                left: 12px;
                right: 12px;
                padding: 12px;
                font-size: 11px;
            }

            .landing-paragraph {
                font-size: 13px;
                line-height: 1.6;
            }

            .unesco-link {
                font-size: 11px;
            }

            .uncover-btn {
                padding: 12px 28px;
                font-size: 13px;
            }
        }

        /* Landscape mobile adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            .title {
                top: 10px;
                left: 10px;
                font-size: 0.9em;
            }

            .nav-container {
                top: 10px;
            }

            .search-container {
                top: 50px;
            }

            .controls {
                bottom: 10px;
                right: 10px;
            }

            .chart-controls {
                bottom: 10px;
            }

            .scatter-description {
                top: 70px;
                max-width: 250px;
                padding: 10px;
                font-size: 10px;
            }
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div id="landing-page">
        <div class="landing-content">
            <p class="landing-paragraph">
                The world is filled with diverse minds and hidden potential, yet not every child has the same opportunities to excel. The latest global PISA data shows a worrying divide: while some countries boast top-tier results, many still struggle to meet basic educational benchmarks. In the future, bright students in remote areas may lack access to quality learning, while those in bustling cities benefit from well-funded schools. Education shouldn't be a lottery. It should open doors and build bridges.
            </p>
            <div class="unesco-link">
                <a href="https://www.oecd.org/pisa/" target="_blank">OECD PISA Data Source</a>
            </div>
            <button class="uncover-btn" id="uncover-btn">Uncover The Story</button>
        </div>
    </div>

    <div id="visualization-container">
        <div class="fade-top-overlay"></div>
        <div id="page-title" class="title">A World of Unequal Learning</div>

        <div class="nav-container">
            <button class="nav-btn active" id="nav-globe">GLOBE</button>
            <button class="nav-btn" id="nav-chart">INSIGHTS</button>
        </div>

        <div class="search-container" id="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Search country...">
            <div class="search-results" id="search-results"></div>
        </div>

        <div class="globe-container" id="globe-container">
            <svg id="globe"></svg>
            <div class="controls">
                <button class="control-btn" id="reset-btn">Reset View</button>
            </div>
        </div>

        <div class="chart-container" id="chart-container">
            <svg id="chart"></svg>
            <div class="scatter-description" id="scatter-description">
                <h3 style="margin: 0 0 12px 0; font-size: clamp(14px, 2vw, 16px); font-weight: 600; color: #5fb3f6;">Study Hours</h3>
                <p style="margin: 0; font-size: clamp(11px, 1.8vw, 13px); line-height: 1.6;">Students who spend more time studying generally achieve higher exam scores. The trend shows a positive relationship, as study hours increase, exam performance improves.</p>
            </div>
            <div class="chart-controls">
                <button class="chart-btn active" id="btn-study">Study Hours</button>
                <button class="chart-btn" id="btn-social">Social Media</button>
                <button class="chart-btn" id="btn-sleep">Sleep</button>
            </div>
        </div>

        <div id="tooltip">
            <div class="tooltip-country"></div>
            <div class="tooltip-score"></div>
        </div>
    </div>

    <script>
        const Config = {
            width: window.innerWidth,
            height: window.innerHeight,
            baseScale: Math.min(window.innerWidth, window.innerHeight) * 0.4,
            rotationSpeed: 0.3,
            transitionDuration: 1000,
            colors: {
                ocean: 'rgba(30, 60, 120, 0.4)',
                landDefault: 'rgba(40, 80, 120, 0.3)',
                landHover: 'rgba(95, 179, 246, 0.5)',
                landSelected: 'rgba(95, 179, 246, 0.7)',
                countryStroke: 'rgba(255, 255, 255, 0.2)'
            }
        };

        const state = {
            rotation: [0, 0],
            selectedCountry: null,
            rotating: true,
            countries: [],
            scatterData: [],
            currentVariable: 'study_hours_per_day'
        };

        const els = {
            landingPage: document.getElementById('landing-page'),
            vizContainer: document.getElementById('visualization-container'),
            uncoverBtn: document.getElementById('uncover-btn'),
            navGlobe: document.getElementById('nav-globe'),
            navChart: document.getElementById('nav-chart'),
            globeContainer: document.getElementById('globe-container'),
            chartContainer: document.getElementById('chart-container'),
            globe: d3.select('#globe'),
            chart: d3.select('#chart'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            resetBtn: document.getElementById('reset-btn')
        };

        els.uncoverBtn.addEventListener('click', () => {
            els.landingPage.classList.add('slide-up');
            els.vizContainer.classList.add('slide-up');
        });

        const projection = d3.geoOrthographic()
            .scale(Config.baseScale)
            .translate([Config.width / 2, Config.height / 2])
            .rotate(state.rotation)
            .clipAngle(90);

        const path = d3.geoPath().projection(projection);

        function setupGlobe() {
            els.globe
                .attr('width', Config.width)
                .attr('height', Config.height);

            els.globe.append('circle')
                .attr('id', 'globe-circle')
                .attr('cx', Config.width / 2)
                .attr('cy', Config.height / 2)
                .attr('r', Config.baseScale)
                .attr('fill', Config.colors.ocean)
                .attr('stroke', 'rgba(95, 179, 246, 0.4)')
                .attr('stroke-width', 2);

            els.globe.append('g').attr('id', 'countries');
        }

        function loadData() {
            Promise.all([
                d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json'),
                d3.csv('https://raw.githubusercontent.com/astanaa/Data_Visualization_Project/refs/heads/main/Dataset/PISA_scores_by_country.csv')
            ]).then(([world, pisaData]) => {
                const pisaMap = {};
                pisaData.forEach(d => {
                    pisaMap[d.Country] = {
                        score: +d['Average PISA Score'],
                        math: +d['PISA Mathematics Score'],
                        reading: +d['PISA Reading Score'],
                        science: +d['PISA Science Score']
                    };
                });

                state.countries = topojson.feature(world, world.objects.countries).features.map(f => {
                    const countryName = f.properties.name;
                    const pisa = pisaMap[countryName];
                    return {
                        ...f,
                        properties: {
                            ...f.properties,
                            pisa: pisa || null
                        }
                    };
                });

                drawCountries();
                if (state.rotating) startRotation();
            }).catch(err => console.error('Data load failed:', err));
        }

        function drawCountries() {
            const countries = els.globe.select('#countries')
                .selectAll('path')
                .data(state.countries);

            countries.enter()
                .append('path')
                .attr('d', path)
                .attr('fill', d => {
                    if (!d.properties.pisa) return Config.colors.landDefault;
                    const score = d.properties.pisa.score;
                    const minScore = 350;
                    const maxScore = 550;
                    const normalized = (score - minScore) / (maxScore - minScore);
                    const intensity = Math.max(0.2, Math.min(1, normalized));
                    const r = Math.floor(95 + (160 - 95) * intensity);
                    const g = Math.floor(179 + (220 - 179) * intensity);
                    const b = Math.floor(246 + (255 - 246) * intensity);
                    return `rgba(${r}, ${g}, ${b}, ${0.3 + intensity * 0.4})`;
                })
                .attr('stroke', Config.colors.countryStroke)
                .attr('stroke-width', 0.5)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    if (state.selectedCountry !== d) {
                        d3.select(this)
                            .attr('fill', Config.colors.landHover)
                            .attr('stroke-width', 1.5);
                    }
                    showTooltip(event, d);
                })
                .on('mousemove', (event) => {
                    d3.select('#tooltip')
                        .style('left', (event.pageX + 15) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function(event, d) {
                    if (state.selectedCountry !== d) {
                        d3.select(this)
                            .attr('fill', d => {
                                if (!d.properties.pisa) return Config.colors.landDefault;
                                const score = d.properties.pisa.score;
                                const minScore = 350;
                                const maxScore = 550;
                                const normalized = (score - minScore) / (maxScore - minScore);
                                const intensity = Math.max(0.2, Math.min(1, normalized));
                                const r = Math.floor(95 + (160 - 95) * intensity);
                                const g = Math.floor(179 + (220 - 179) * intensity);
                                const b = Math.floor(246 + (255 - 246) * intensity);
                                return `rgba(${r}, ${g}, ${b}, ${0.3 + intensity * 0.4})`;
                            })
                            .attr('stroke-width', 0.5);
                    }
                    hideTooltip();
                })
                .on('click', (event, d) => handleCountryClick(d));

            countries.attr('d', path);
        }

        function showTooltip(event, d) {
            const tooltip = d3.select('#tooltip');
            const countryName = d.properties.name;
            const pisa = d.properties.pisa;

            tooltip.select('.tooltip-country').text(countryName);

            if (pisa) {
                tooltip.select('.tooltip-score').html(`
                    Average: ${pisa.score.toFixed(0)}<br>
                    Math: ${pisa.math.toFixed(0)} | Reading: ${pisa.reading.toFixed(0)} | Science: ${pisa.science.toFixed(0)}
                `);
            } else {
                tooltip.select('.tooltip-score').text('No PISA data available');
            }

            tooltip
                .classed('show', true)
                .style('left', (event.pageX + 15) + 'px')
                .style('top', (event.pageY - 28) + 'px');
        }

        function hideTooltip() {
            d3.select('#tooltip').classed('show', false);
        }

        function handleCountryClick(feature) {
            state.rotating = false;
            state.selectedCountry = feature;

            els.globe.selectAll('path')
                .attr('fill', d => {
                    if (d === feature) return Config.colors.landSelected;
                    if (!d.properties.pisa) return Config.colors.landDefault;
                    const score = d.properties.pisa.score;
                    const minScore = 350;
                    const maxScore = 550;
                    const normalized = (score - minScore) / (maxScore - minScore);
                    const intensity = Math.max(0.2, Math.min(1, normalized));
                    const r = Math.floor(95 + (160 - 95) * intensity);
                    const g = Math.floor(179 + (220 - 179) * intensity);
                    const b = Math.floor(246 + (255 - 246) * intensity);
                    return `rgba(${r}, ${g}, ${b}, ${0.3 + intensity * 0.4})`;
                })
                .attr('stroke-width', d => d === feature ? 2 : 0.5);

            const centroid = d3.geoCentroid(feature);
            const targetRotation = [-centroid[0], -centroid[1]];

            d3.transition()
                .duration(Config.transitionDuration)
                .tween('rotate', () => {
                    const r = d3.interpolate(projection.rotate(), targetRotation);
                    return t => {
                        projection.rotate(r(t));
                        refresh();
                    };
                });
        }

        function zoomOut() {
            state.rotating = true;
            state.selectedCountry = null;

            els.globe.selectAll('path')
                .attr('fill', d => {
                    if (!d.properties.pisa) return Config.colors.landDefault;
                    const score = d.properties.pisa.score;
                    const minScore = 350;
                    const maxScore = 550;
                    const normalized = (score - minScore) / (maxScore - minScore);
                    const intensity = Math.max(0.2, Math.min(1, normalized));
                    const r = Math.floor(95 + (160 - 95) * intensity);
                    const g = Math.floor(179 + (220 - 179) * intensity);
                    const b = Math.floor(246 + (255 - 246) * intensity);
                    return `rgba(${r}, ${g}, ${b}, ${0.3 + intensity * 0.4})`;
                })
                .attr('stroke-width', 0.5);

            startRotation();
        }

        function startRotation() {
            d3.timer(elapsed => {
                if (!state.rotating) return true;
                state.rotation[0] += Config.rotationSpeed;
                projection.rotate(state.rotation);
                refresh();
            });
        }

        function refresh() {
            els.globe.selectAll('#countries path').attr('d', path);
        }

        function setupPisaTooltip() {
            els.searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length === 0) {
                    els.searchResults.classList.remove('show');
                    return;
                }

                const matches = state.countries
                    .filter(f => f.properties.name.toLowerCase().includes(query))
                    .slice(0, 5);

                if (matches.length > 0) {
                    els.searchResults.innerHTML = matches
                        .map(f => `<div class="search-result-item" data-country="${f.properties.name}">${f.properties.name}</div>`)
                        .join('');
                    els.searchResults.classList.add('show');

                    els.searchResults.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', () => selectFromSearch(item.dataset.country));
                    });
                } else {
                    els.searchResults.classList.remove('show');
                }
            });

            document.addEventListener('click', (e) => {
                if (!els.searchInput.contains(e.target) && !els.searchResults.contains(e.target)) {
                    els.searchResults.classList.remove('show');
                }
            });
        }

        function selectFromSearch(country) {
            const feature = state.countries.find(f => f.properties.name === country);
            if (feature) {
                handleCountryClick(feature);
                els.searchInput.value = '';
                els.searchResults.classList.remove('show');
            }
        }

        els.navGlobe.addEventListener('click', () => {
            els.navGlobe.classList.add('active');
            els.navChart.classList.remove('active');
            els.globeContainer.classList.remove('slide-up');
            els.chartContainer.classList.remove('slide-up');
            document.getElementById('page-title').textContent = 'A World of Unequal Learning';
            document.getElementById('search-container').style.display = 'block';
        });

        els.navChart.addEventListener('click', () => {
            els.navChart.classList.add('active');
            els.navGlobe.classList.remove('active');
            els.globeContainer.classList.add('slide-up');
            els.chartContainer.classList.add('slide-up');
            document.getElementById('page-title').textContent = "Smart Habits, Better Scores";
            document.getElementById('search-container').style.display = 'none';
        });

        els.resetBtn.addEventListener('click', zoomOut);

        ['study', 'social', 'sleep'].forEach(type => {
            const varMap = { study: 'study_hours_per_day', social: 'social_media_hours', sleep: 'sleep_hours' };
            document.getElementById(`btn-${type}`).addEventListener('click', () => {
                state.currentVariable = varMap[type];
                drawScatterPlot(state.scatterData, varMap[type]);
                updateChartButtons(`btn-${type}`);
            });
        });

        function updateChartButtons(activeId) {
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');

            const descriptions = {
                'btn-study': {
                    title: 'Study Hours',
                    text: 'Students who spend more time studying generally achieve higher exam scores. The trend shows a positive relationship, as study hours increase, exam performance improves.'
                },
                'btn-social': {
                    title: 'Social Media Hours',
                    text: 'There is a negative relationship between social media usage and exam scores. Students who spend more hours on social media tend to have lower exam performance, possibly due to reduced focus and study time.'
                },
                'btn-sleep': {
                    title: 'Sleep Hours',
                    text: 'The relationship between sleep and exam performance appears moderately positive up to an optimal point. Students who sleep around 7â€“8 hours tend to perform best.'
                }
            };

            const desc = descriptions[activeId];
            document.getElementById('scatter-description').innerHTML = `
                <h3 style="margin: 0 0 12px 0; font-size: clamp(14px, 2vw, 16px); font-weight: 600; color: #5fb3f6;">${desc.title}</h3>
                <p style="margin: 0; font-size: clamp(11px, 1.8vw, 13px); line-height: 1.6;">${desc.text}</p>`;
        }

        window.addEventListener('resize', () => {
            Config.width = window.innerWidth;
            Config.height = window.innerHeight;
            Config.baseScale = Math.min(Config.width, Config.height) * 0.4;
            els.globe.attr('width', Config.width).attr('height', Config.height);
            projection.scale(Config.baseScale).translate([Config.width / 2, Config.height / 2]);
            d3.select('#globe-circle').attr('cx', Config.width / 2).attr('cy', Config.height / 2).attr('r', Config.baseScale);
            refresh();
            
            if (state.scatterData.length > 0) {
                drawScatterPlot(state.scatterData, state.currentVariable);
            }
        });

        function loadScatterData() {
            fetch('https://raw.githubusercontent.com/astanaa/Data_Visualization_Project/refs/heads/main/Dataset/Student_Habits_Dataset.csv')
                .then(r => r.text())
                .then(csvText => {
                    state.scatterData = Papa.parse(csvText, { header: true, dynamicTyping: true, skipEmptyLines: true }).data;
                    drawScatterPlot(state.scatterData, 'study_hours_per_day');
                })
                .catch(err => console.error('Scatter data load failed:', err));
        }

        function drawScatterPlot(data, variable = 'study_hours_per_day') {
            const validData = data.filter(d => d[variable] != null && d['exam_score'] != null && !isNaN(d[variable]) && !isNaN(d['exam_score']));
            if (validData.length === 0) { console.error('No valid data for scatter plot'); return; }

            // Responsive sizing for scatter plot
            const isMobile = Config.width < 768;
            const isSmallMobile = Config.width < 480;
            
            let descBoxWidth, plotWidth, plotHeight, margin, centerX, centerY;
            
            if (isSmallMobile) {
                descBoxWidth = 0; // Hide description box on small mobile
                plotWidth = Math.min(Config.width - 40, 400);
                plotHeight = Math.min(Config.height * 0.5, 400);
                margin = { top: 20, right: 20, bottom: 40, left: 50 };
                centerX = (Config.width - plotWidth) / 2;
                centerY = Config.height * 0.25;
            } else if (isMobile) {
                descBoxWidth = 0; // Hide description box on mobile
                plotWidth = Math.min(Config.width - 60, 500);
                plotHeight = Math.min(Config.height * 0.55, 500);
                margin = { top: 25, right: 25, bottom: 45, left: 55 };
                centerX = (Config.width - plotWidth) / 2;
                centerY = Config.height * 0.22;
            } else {
                descBoxWidth = Math.min(350, Config.width * 0.25);
                const availableWidth = Config.width - descBoxWidth - 80;
                plotWidth = Math.max(Math.min(availableWidth * 0.9, 1200), 400);
                plotHeight = Math.max(Math.min(Config.height * 0.60, 600), 350);
                margin = { top: 30, right: 30, bottom: 50, left: 60 };
                centerX = Math.max(descBoxWidth + 40, descBoxWidth + (Config.width - descBoxWidth - plotWidth) / 2);
                centerY = (Config.height - plotHeight) / 2;
            }

            const width = plotWidth - margin.left - margin.right;
            const height = plotHeight - margin.top - margin.bottom;

            els.chart.selectAll('*').remove();

            const g = els.chart.attr('width', Config.width).attr('height', Config.height)
                .append('g').attr('transform', `translate(${centerX + margin.left},${centerY + margin.top})`);

            const xScale = d3.scaleLinear().domain([0, d3.max(validData, d => d[variable]) * 1.1]).range([0, width]);
            const yScale = d3.scaleLinear().domain([0, d3.max(validData, d => d['exam_score']) * 1.05]).range([height, 0]);

            const variableLabels = {
                'study_hours_per_day': 'Study Hours Per Day',
                'social_media_hours': 'Social Media Hours Per Day',
                'sleep_hours': 'Sleep Hours Per Day'
            };
            const xAxisLabel = variableLabels[variable] || variable;

            g.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(xScale))
                .attr('color', 'rgba(255, 255, 255, 0.6)')
                .append('text').attr('x', width / 2).attr('y', 40).attr('fill', '#5fb3f6')
                .attr('text-anchor', 'middle').attr('font-size', isMobile ? '13px' : '16px').attr('font-weight', '600').text(xAxisLabel);

            g.append('g').call(d3.axisLeft(yScale)).attr('color', 'rgba(255, 255, 255, 0.6)')
                .append('text').attr('transform', 'rotate(-90)').attr('x', -height / 2).attr('y', -45)
                .attr('fill', '#5fb3f6').attr('text-anchor', 'middle').attr('font-size', isMobile ? '13px' : '16px')
                .attr('font-weight', '600').text('Exam Score');

            g.insert('rect', ':first-child')
                .attr('x', -margin.left - 20).attr('y', -margin.top - 20)
                .attr('width', plotWidth + 40).attr('height', plotHeight + 40)
                .attr('fill', 'rgb(10, 20, 40)').attr('stroke', 'rgba(95, 179, 246, 0.3)')
                .attr('stroke-width', 1.5).attr('rx', 8);

            g.append('g').attr('class', 'grid').attr('opacity', 0.1)
                .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(''));

            const dotRadius = isMobile ? 4 : 5;
            const hoverRadius = isMobile ? 6 : 7;

            g.selectAll('.dot').data(validData).enter().append('circle').attr('class', 'dot')
                .attr('cx', d => xScale(d[variable])).attr('cy', d => yScale(d['exam_score'])).attr('r', dotRadius)
                .attr('fill', d => d['gender'] === 'Male' ? '#5fb3f6' : '#ff6b9d')
                .attr('opacity', 0.7).attr('stroke', 'white').attr('stroke-width', 1.5)
                .on('mouseover', function(e, d) {
                    d3.select(this).attr('r', hoverRadius).attr('opacity', 1);
                    const tooltip = d3.select('#tooltip');
                    tooltip.select('.tooltip-country').text(`${d['gender']} | ${xAxisLabel}: ${d[variable].toFixed(1)}`);
                    tooltip.select('.tooltip-score').text(`Exam Score: ${d['exam_score'].toFixed(1)}`);
                    tooltip.classed('show', true).style('left', (e.pageX + 15) + 'px').style('top', (e.pageY - 28) + 'px');
                })
                .on('mousemove', (e) => d3.select('#tooltip').style('left', (e.pageX + 15) + 'px').style('top', (e.pageY - 28) + 'px'))
                .on('mouseout', function() {
                    d3.select(this).attr('r', dotRadius).attr('opacity', 0.7);
                    d3.select('#tooltip').classed('show', false);
                });

            const titleFontSize = isMobile ? '16px' : '22px';
            els.chart.append('text').attr('x', centerX + plotWidth / 2).attr('y', centerY + 20)
                .attr('text-anchor', 'middle').attr('fill', '#5fb3f6').attr('font-size', titleFontSize)
                .attr('font-weight', '600').text(`${xAxisLabel} vs Exam Score`);

            // Legend
            const legendX = centerX + plotWidth - 150;
            const legendY = centerY + 50;

            els.chart.append('rect').attr('x', legendX - 15).attr('y', legendY - 20)
                .attr('width', 130).attr('height', 70).attr('fill', 'rgb(10, 20, 40)')
                .attr('stroke', 'rgba(95, 179, 246, 0.3)').attr('stroke-width', 1.5).attr('rx', 8);

            els.chart.append('circle').attr('cx', legendX).attr('cy', legendY).attr('r', dotRadius)
                .attr('fill', '#5fb3f6').attr('opacity', 0.7);
            els.chart.append('text').attr('x', legendX + 20).attr('y', legendY + 5)
                .attr('fill', 'rgba(255, 255, 255, 0.8)').attr('font-size', isMobile ? '11px' : '13px').text('Male');

            els.chart.append('circle').attr('cx', legendX).attr('cy', legendY + 30).attr('r', dotRadius)
                .attr('fill', '#ff6b9d').attr('opacity', 0.7);
            els.chart.append('text').attr('x', legendX + 20).attr('y', legendY + 35)
                .attr('fill', 'rgba(255, 255, 255, 0.8)').attr('font-size', isMobile ? '11px' : '13px').text('Female');
        }

        setupGlobe();
        loadData();
        loadScatterData();
        setupPisaTooltip();
    </script>
</body>
</html>
